<!DOCTYPE html>
<html lang="th" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="เกมทายเลขแบบ Multiplayer สนุกๆ ที่เล่นได้ทั้งบนมือถือและคอมพิวเตอร์">
    <title>เกมทายเลข - สนุกทุกที่ ทุกเวลา</title>
    
    <!-- Google Fonts - Mitr -->
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connection-status" class="hidden">
        <div class="connection-indicator">●</div>
        <span>การเชื่อมต่ออินเทอร์เน็ตถูกตัดขาด</span>
    </div>

    <!-- Screens Container -->
    <div class="screens-container">
        <!-- Splash Screen -->
        <div id="splash-screen" class="game-screen" aria-hidden="true">
            <div class="splash-content">
                <h1 class="splash-title">เกมทายเลข</h1>
                <div class="instructions">
                    <h2>วิธีการเล่น</h2>
                    <ol>
                        <li>แต่ละคนจะตั้งตัวเลข 4 หลักที่ไม่ซ้ำกัน</li>
                        <li>ผลัดกันทายตัวเลขของผู้เล่นคนอื่น</li>
                        <li>S = ถูกทั้งตัวเลขและตำแหน่ง, B = ถูกตัวเลขแต่ผิดตำแหน่ง</li>
                        <li>ผู้เล่นที่ทายเลขของผู้เล่นคนอื่นถูก หรือเป็นผู้รอดชีวิตคนสุดท้ายจะเป็นผู้ชนะ</li>
                    </ol>
                    <p class="start-prompt">แตะที่ใดก็ได้เพื่อเริ่ม</p>
                </div>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="game-screen" aria-hidden="true">
            <div class="lobby-container">
                <div class="lobby-box">
                    <h1 class="lobby-title">เกมทายเลข</h1>
                    <p class="lobby-description">เชิญชวนเพื่อนมาเล่นด้วยกัน!</p>
                    
                    <button id="go-to-create-btn" class="lobby-button">สร้างห้องใหม่</button>
                    <button id="go-to-join-btn" class="lobby-button secondary">เข้าร่วมห้อง</button>
                </div>
            </div>
        </div>

        <!-- Create Room Screen -->
        <div id="create-room-screen" class="game-screen" aria-hidden="true">
            <div class="lobby-container">
                <div class="lobby-box">
                    <h1 class="lobby-title">สร้างห้องใหม่</h1>
                    
                    <input type="text" id="host-name-input" class="lobby-input" placeholder="ชื่อของคุณ" maxlength="20">
                    <input type="text" id="new-room-name-input" class="lobby-input" placeholder="ชื่อห้อง" maxlength="30">
                    <input type="password" id="new-room-password-input" class="lobby-input" placeholder="รหัสผ่าน (4 ตัวเลข)" pattern="\d{4}" maxlength="4">
                    
                    <button id="confirm-create-btn" class="lobby-button">สร้างห้อง</button>
                </div>
            </div>
        </div>

        <!-- Room List Screen -->
        <div id="room-list-screen" class="game-screen" aria-hidden="true">
            <div class="lobby-container">
                <div class="lobby-box">
                    <h1 class="lobby-title">เลือกห้อง</h1>
                    <p class="lobby-description">เลือกห้องที่ต้องการเข้าร่วม</p>
                    
                    <div id="room-list-content"></div>
                </div>
            </div>
        </div>

        <!-- Joiner Setup Screen -->
        <div id="joiner-setup-screen" class="game-screen" aria-hidden="true">
            <div class="lobby-container">
                <div class="lobby-box">
                    <h1 class="lobby-title">เข้าร่วมห้อง</h1>
                    <p class="lobby-description">ชื่อห้อง: <span id="joiner-room-name-display"></span></p>
                    
                    <input type="text" id="joiner-name-input" class="lobby-input" placeholder="ชื่อของคุณ" maxlength="20">
                    
                    <button id="confirm-join-btn" class="lobby-button">เข้าร่วม</button>
                </div>
            </div>
        </div>

        <!-- Waiting Room Screen -->
        <div id="waiting-room-screen" class="game-screen" aria-hidden="true">
            <div class="waiting-room-container">
                <h1 class="waiting-room-title">รอผู้เล่น</h1>
                <div class="room-code-display" id="room-code-text">กำลังโหลด...</div>
                
                <div class="player-list">
                    <div id="player1-slot" class="player-slot">
                        <div class="player-avatar-initial">?</div>
                        <div class="player-name">ผู้เล่น 1</div>
                        <div class="player-status waiting">กำลังรอ...</div>
                    </div>
                    <div id="player2-slot" class="player-slot">
                        <div class="player-avatar-initial">?</div>
                        <div class="player-name">ผู้เล่น 2</div>
                        <div class="player-status waiting">กำลังรอ...</div>
                    </div>
                    <div id="player3-slot" class="player-slot">
                        <div class="player-avatar-initial">?</div>
                        <div class="player-name">ผู้เล่น 3</div>
                        <div class="player-status waiting">กำลังรอ...</div>
                    </div>
                    <div id="player4-slot" class="player-slot">
                        <div class="player-avatar-initial">?</div>
                        <div class="player-name">ผู้เล่น 4</div>
                        <div class="player-status waiting">กำลังรอ...</div>
                    </div>
                </div>
                
                <p id="waiting-message" class="waiting-message">รอผู้เล่นอย่างน้อย 2 คน...</p>
                <button id="start-game-btn" class="lobby-button" disabled>เริ่มเกม</button>
            </div>
        </div>

        <!-- Main Game Screen -->
        <div id="main-game-screen" class="game-screen" aria-hidden="true">
            <div class="main-container">
                <!-- Turn Indicator -->
                <div id="turn-indicator" role="status" aria-live="polite" class="their-turn">
                    <span id="turn-text">ตาของ ผู้เล่น 2</span>
                    <span id="turn-timer-display">20</span>
                </div>
                
                <!-- Our Number Display -->
                <div class="section">
                    <h2 class="section-title">ตัวเลขของคุณ</h2>
                    <div id="our-number-display" class="input-container">
                        <!-- จะถูกเติมด้วย JavaScript -->
                    </div>
                </div>
                
                <!-- Player Summary Grid -->
                <div class="section">
                    <h2 class="section-title">ผู้เล่น</h2>
                    <div id="player-summary-grid" role="radiogroup" aria-label="เลือกผู้เล่นเป้าหมาย"></div>
                </div>
                
                <!-- History Log -->
                <div class="section">
                    <h2 class="section-title">ประวัติการทาย <span id="history-target-name">ไม่มี</span></h2>
                    <div id="history-log" class="history-log"></div>
                </div>
                
                <!-- Guess Input -->
                <div class="section">
                    <h2 class="section-title">ทายตัวเลข</h2>
                    <div id="guess-number-container" class="input-container">
                        <div class="number-input"></div>
                        <div class="number-input"></div>
                        <div class="number-input"></div>
                        <div class="number-input"></div>
                    </div>
                    
                    <!-- Number Pad -->
                    <div id="number-pad-container" class="number-grid"></div>
                    
                    <!-- Final Answer Section -->
                    <div class="final-answer-section">
                        <div class="final-answer-chances">
                            <div class="chance-dot"></div>
                            <div class="chance-dot"></div>
                            <div class="chance-dot"></div>
                        </div>
                        <button id="submit-final-answer-btn" class="final-answer-button">ส่งคำตอบสุดท้าย</button>
                    </div>
                </div>
                
                <!-- Spectator Overlay -->
                <div id="spectator-overlay" class="spectator-overlay">
                    <div class="spectator-message">คุณแพ้แล้ว! กำลังรับชม...</div>
                </div>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="game-screen" aria-hidden="true">
            <div class="game-over-container">
                <h1 id="game-over-title" class="game-over-title">จบเกมแล้ว</h1>
                <h2 id="winner-name" class="winner-name">ผู้ชนะคือ: ผู้เล่น 1</h2>
                <p id="game-over-message" class="game-over-message">เป็นผู้รอดชีวิตคนสุดท้าย!</p>
                
                <div id="game-over-numbers-container" class="game-over-numbers"></div>
                
                <div class="game-over-buttons">
                    <button id="rematch-btn" class="lobby-button">เล่นอีกครั้ง</button>
                    <button id="back-to-lobby-btn" class="lobby-button secondary">กลับสู่หน้าหลัก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="password-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="password-modal-room-name" class="modal-title">กรอกรหัสผ่าน</h2>
            <input type="password" id="password-modal-input" class="lobby-input" placeholder="รหัสผ่าน 4 ตัว" maxlength="4">
            <button id="password-modal-submit-btn" class="lobby-button">ยืนยัน</button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" role="alert" aria-live="polite" class="toast-notification"></div>
    <div id="action-toast" role="status" aria-live="polite" class="action-toast">
        <span id="action-toast-text"></span>
    </div>

    <!-- Sound Control -->
    <button id="sound-control" aria-label="เปิด/ปิด เสียง">
        <span id="sound-icon">🔊</span>
    </button>

    <!-- Scripts -->
    <script type="module">
        // ตรวจสอบการสนับสนุน WebP
        const checkWebP = new Promise((resolve) => {
            const webP = new Image();
            webP.onload = webP.onerror = () => resolve(webP.height === 2);
            webP.src = 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IIcAAACyAgCdASoCAAEALmk0mk0iIiIiIgBoSygABc6hWWSAAAA=';
        });
        
        // โหลด Firebase SDK ก่อน
        (async function() {
            const supportsWebP = await checkWebP;
            
            // โหลด Firebase SDK
            const firebaseScript = document.createElement('script');
            firebaseScript.src = "https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js";
            document.head.appendChild(firebaseScript);
            
            const firebaseDBScript = document.createElement('script');
            firebaseDBScript.src = "https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js";
            document.head.appendChild(firebaseDBScript);
            
            const firebaseAuthScript = document.createElement('script');
            firebaseAuthScript.src = "https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js";
            document.head.appendChild(firebaseAuthScript);
            
            // รอให้ Firebase โหลดเสร็จ
            await new Promise((resolve) => {
                firebaseScript.onload = resolve;
            });
            
            // โหลดไฟล์หลัก
            const mainScript = document.createElement('script');
            mainScript.type = "modu